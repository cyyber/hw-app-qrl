<html>
<head>
<script src="bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <h1>QRL <-> LedgerJS interface diagnostics</h1>
  <h4>1. Ensure Ledger plugged in and unlocked</h4>
  <h4>2. Pair WebUSB</h4>
  <button class="pairWebUSB">Pair WebUSB</button>
  <p>Ensure QRL app open</p>
  <button class="getInfo">Get info</button>
  <h1>U2F</h1>
  <button class="testU2F">Get version</button>
<script>
/* eslint-disable */

async function getConfig(qrl) {
  var r = await qrl.getAppConfiguration();
  return r
}

async function getUSBDevices() {
  var d = await navigator.usb.getDevices();
  return d
}

async function checkU2F() {
  return transports[0].clazz.isSupported()
}

async function checkWebUSB() {
  return transports[1].clazz.isSupported()
}

async function checkSupported() {
  var u2f = await checkU2F();
  var webusb = await checkWebUSB();
  console.log('u2f support: ' + u2f);
  console.log('webusb support: ' + webusb);
}

async function askUSBPermissions() {
  return TransportWebUSB.create();
}

async function pairWebUSB() {
  var permission = false;
  try {
    await askUSBPermissions();
    permission = true;
  } catch (e) {
    var d = await getUSBDevices();
    if (d.length > 0) {
      permission = true;
    }
  }
  // if devices available as list here we can assume permission granted
  console.log('WebUSB pairing permission: '+ permission);
}

async function setUSBtransport(devices) {
    var transport = await new TransportWebUSB(devices[0]);
    return transport
}

async function openUSBChannel(devices) {
  return TransportWebUSB.open(devices[0])
}

async function getInfoWebUSB() {
  try {
    var devices = await getUSBDevices();
  } catch (e) {
    console.log(e);
  }
  // TODO: check it is the correct device
  var transport = await setUSBtransport(devices);
  
  transport = await openUSBChannel(devices);

  var qrl = await new Qrl(transport);
  var r = await getConfig(qrl);
  console.log(r);
}

$(document).ready(function() {
  checkSupported();
  // U2F
  $('.testU2F').click(function() {
    var transport = new transports[0].clazz
    var qrl = new Qrl(transport);
    getConfig(qrl).then(function (r) { console.log(r) })
  });
  // WebUSB
  $('.pairWebUSB').click(function() {
    pairWebUSB();
  });
  $('.getInfo').click(function() {
    getInfoWebUSB();
  });
});
</script>
</body>
</html>