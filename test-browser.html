<html>
<head>
<script src="bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <h1>QRL <-> LedgerJS interface diagnostics</h1>
  <h4>Ensure Ledger plugged in, unlocked and QRL app open</h4>
  <p><button class="getVersion">Get Version</button></p>
  <p><button class="getState">Get State</button></p>
  <p><button class="getPublicKey">Get Public Key</button></p>
  <p><button class="viewAddress">View Address on Device</button></p>
  <p><button class="OTS0">Set OTS 0</button></p>
  <p><button class="OTS100">Set OTS 100</button></p>
<script>
/* eslint-disable */

function ledgerReturnedError(e) {
  var r = false;
  try {
    if (e.name === 'TransportStatusError') {
      r = true;
    }
  } catch (e) {
    r = false;
  }
  return r;
}

async function getUSBDevices() {
  var d = await navigator.usb.getDevices();
  return d
}

async function checkU2F() {
  return transports[0].clazz.isSupported()
}

async function checkWebUSB() {
  return (!navigator.platform.toLowerCase().includes('win') && (await transports[1].clazz.isSupported()))
}

async function checkSupported() {
  var u2f = await checkU2F();
  var webusb = await checkWebUSB();
  console.log('u2f support: ' + u2f);
  console.log('webusb support: ' + webusb);
}

async function createTransport() {
  var transport = null;
  if (checkWebUSB()) {
    transport = await transports[1].clazz.create();
  } else {
    transport = await transports[0].clazz.create();
  }
  var qrl = await new Qrl(transport);
  return qrl
}

async function getVersion() {
  var qrl = await createTransport();
  await qrl.get_version().then(function(r) {
    if (!ledgerReturnedError(r)) {
      console.log('Success: ', r);
    } else {
      console.log('Fail: ', r);
    }
  }).catch(function(e) {
    console.log('Error getting version: ', e);
  }); 
}

async function getState() {
  var qrl = await createTransport();
  await qrl.get_state().then(function(result) {
    if (!ledgerReturnedError(result)) {
      console.log('Success: ', result);
    } else {
      console.log('Fail: ', result);
    }
  }).catch(function(e) {
    console.log('Error getting state: ', e);
  }); 
}

async function getPublicKey() {
  var qrl = await createTransport();
  await qrl.publickey().then(function(result) {
    if (!ledgerReturnedError(result)) {
      console.log('Success: ', result);
      const pkHex = Buffer.from(result.public_key).toString('hex');
      console.log('Hex version: ', pkHex);
    } else {
      console.log('Fail: ', result);
    }
  }).catch(function(e) {
    console.log('Error getting public key: ', e);
  }); 
}

async function viewAddress() {
  var qrl = await createTransport();
  await qrl.viewAddress().then(function(result) {
    if (!ledgerReturnedError(result)) {
      console.log('Success: address displayed on device');
    } else {
      console.log('Fail: ', result);
    }
  }).catch(function(e) {
    console.log('Error showing address: ', e);
  }); 
}

async function setOTS(idx) {
  var qrl = await createTransport();
  await qrl.setIdx(idx).then(function(result) {
    if (!ledgerReturnedError(result)) {
      console.log('Success: address displayed on device', result);
    } else {
      console.log('Fail: ', result);
    }
  }).catch(function(e) {
    console.log('Error showing address: ', e);
  }); 
}

$(document).ready(function() {
  checkSupported();
  $('.getVersion').click(function() {
    getVersion();
  });
  $('.getState').click(function() {
    getState();
  });
  $('.getPublicKey').click(function() {
    getPublicKey();
  });
  $('.viewAddress').click(function() {
    viewAddress();
  });
  $('.OTS0').click(function() {
    setOTS(0);
  });
  $('.OTS100').click(function() {
    setOTS(100);
  });
});
</script>
</body>
</html>