<html>
<head>
<script src="bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <h1>QRL <-> LedgerJS interface diagnostics</h1>
  <h4>Ensure Ledger plugged in, unlocked and QRL app open</h4>
  <p><button class="getVersion">Get Version</button></p>
  <p><button class="getState">Get State</button></p>
<script>
/* eslint-disable */

async function getUSBDevices() {
  var d = await navigator.usb.getDevices();
  return d
}

async function checkU2F() {
  return transports[0].clazz.isSupported()
}

async function checkWebUSB() {
  return (!navigator.platform.toLowerCase().includes('win') && (await transports[1].clazz.isSupported()))
}

async function checkSupported() {
  var u2f = await checkU2F();
  var webusb = await checkWebUSB();
  console.log('u2f support: ' + u2f);
  console.log('webusb support: ' + webusb);
}

async function createTransport() {
  var transport = null;
  if (checkWebUSB()) {
    transport = await transports[1].clazz.create()
  } else {
    transport = await transports[0].clazz.create()
  }
  var qrl = await new Qrl(transport);
  return qrl
}

async function getVersion() {
  var qrl = await createTransport();
  await qrl.get_version().then(function(r) {
    console.log('Success:', r)
  }).catch(function(e) {
    console.log('Error getting version: ', e)
    if (e.statusCode === 28160) {
      console.log('Ledger is ready but QRL app not open')
    }
  }); 
}

async function getState() {
  var qrl = await createTransport();
  await qrl.get_state().then(function(result) {
    console.log(result)
  }).catch(function(e) {
    console.log('Error getting version: ', e)
    if (e.statusCode === 28160) {
      console.log('Ledger is ready but QRL app not open')
    }
  }); 
}

$(document).ready(function() {
  checkSupported();
  $('.getVersion').click(function() {
    getVersion();
  });
  $('.getState').click(function() {
    getState();
  });
});
</script>
</body>
</html>